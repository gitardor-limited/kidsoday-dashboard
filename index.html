<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>User Dashboard</title>

    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
      }
      .card {
        border: 1px solid #ccc;
        padding: 15px;
        margin: 15px 0;
        border-radius: 6px;
      }
      a.button-link {
        display: inline-block;
        padding: 8px 14px;
        background: #1a73e8;
        color: #fff;
        text-decoration: none;
        border-radius: 4px;
        font-weight: bold;
      }
      a.button-link:hover {
        background: #1558b0;
      }
    </style>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
  </head>

  <body>
    <h2>Your Dashboard</h2>

    <div id="loginButton"></div>
    <div id="output">Loading...</div>

    <script>
      function renderDashboard(data) {
        const output = document.getElementById("output");

        if (!data || data.error) {
          output.innerHTML =
            `<p style="color:red;">${data?.error || "Unable to load dashboard"}</p>`;
          return;
        }

        let html = `<p><strong>Signed in as:</strong> ${data.email}</p>`;

        if (data.records.length === 0) {
          html += "<p>No data available for your account.</p>";
        } else {
          data.records.forEach(record => {
            html += `<div class="card">`;

            for (let key in record) {
              const value = record[key];

              // âœ… SPECIAL HANDLING FOR COURSE URL
              if (key === "Course URL" && value) {
                html += `
                  <p>
                    <strong>${key}:</strong><br>
                    <a class="button-link" href="${value}" target="_blank" rel="noopener">
                      GoToLevel
                    </a>
                  </p>
                `;
              } else {
                html += `<p><strong>${key}:</strong> ${value}</p>`;
              }
            }

            html += `</div>`;
          });
        }

        output.innerHTML = html;
      }

      function handleLogin(response) {
        const payload = JSON.parse(
          atob(response.credential.split(".")[1])
        );
        const email = payload.email;

        const url =
          "https://script.google.com/macros/s/AKfycbyeKrGPdEFxzq312Z4lnjYKjvhupSL2SkGos1LtzbSmO1YVWWFNpEHY29248uYN_-xHgA/exec?email=" +
          encodeURIComponent(email);

        fetch(url)
          .then(res => res.json())
          .then(renderDashboard)
          .catch(err => {
            document.getElementById("output").innerHTML =
              "<p style='color:red;'>Error fetching dashboard</p>";
            console.error(err);
          });
      }

      window.onload = function () {
        google.accounts.id.initialize({
          client_id:
            "650276142872-5gdqkjqvrrcb943jkf2r8i3424g5ruah.apps.googleusercontent.com",
          callback: handleLogin
        });

        google.accounts.id.renderButton(
          document.getElementById("loginButton"),
          { theme: "outline", size: "large" }
        );

        google.accounts.id.prompt();
      };
    </script>
  </body>
</html>

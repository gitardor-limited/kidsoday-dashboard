<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>User Dashboard</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    .card {
      border: 1px solid #ccc;
      padding: 15px;
      margin: 15px 0;
      border-radius: 6px;
    }
    a.button-link {
      display: inline-block;
      padding: 8px 14px;
      background: #1a73e8;
      color: #fff;
      text-decoration: none;
      border-radius: 4px;
      font-weight: bold;
    }
  </style>

  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>

<body>
  <h2>Your Dashboard</h2>
  <div id="output">Checking session…</div>

<script>
  function renderDashboard(data) {
    const output = document.getElementById("output");

    if (!data || data.error) {
      output.innerHTML = `<p style="color:red;">${data.error}</p>`;
      return;
    }

    let html = `<p><strong>Signed in as:</strong> ${data.email}</p>`;

    if (!data.records.length) {
      html += "<p>No data available.</p>";
    } else {
      data.records.forEach(r => {
        html += `<div class="card">`;
        for (let k in r) {
          if (k === "Course URL") {
            html += `
              <p><strong>Course:</strong><br>
              <a class="button-link" href="${r[k]}" target="_blank">GoToLevel</a></p>
            `;
          } else {
            html += `<p><strong>${k}:</strong> ${r[k]}</p>`;
          }
        }
        html += `</div>`;
      });
    }

    output.innerHTML = html;
  }

  function handleLogin(response) {
    const payload = JSON.parse(atob(response.credential.split(".")[1]));
    const email = payload.email;

    fetch(
      "https://script.google.com/macros/s/AKfycbyeKrGPdEFxzq312Z4lnjYKjvhupSL2SkGos1LtzbSmO1YVWWFNpEHY29248uYN_-xHgA/exec?email=" +
      encodeURIComponent(email)
    )
      .then(r => r.json())
      .then(renderDashboard)
      .catch(() => {
        document.getElementById("output").innerHTML =
          "<p style='color:red;'>Failed to load dashboard</p>";
      });
  }

  window.onload = () => {
    google.accounts.id.initialize({
      client_id: "656751987892-s5h4b3h7aq6rl63ut7pl6hgm3d2vr46p.apps.googleusercontent.com",
      callback: handleLogin,
      auto_select: true
    });

    // ✅ One Tap ONLY
    google.accounts.id.prompt(notification => {
      if (notification.isNotDisplayed() || notification.isSkippedMoment()) {
        document.getElementById("output").innerHTML =
          "<p>Please sign in with Google to view your dashboard.</p>";
      }
    });
  };
</script>
</body>
</html>
